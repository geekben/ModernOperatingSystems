##1.3 计算机硬件概览
操作系统与其运行的硬件环境是紧密相关的。它延伸了计算机的指令集并且为计算机管理各种资源。要让计算机正常工作，操作系统必须非常了解硬件，至少要对这些硬件暴露给程序员的接口了如指掌。因此，让我们简要的浏览一下当今计算机系统通常使用的硬件设备。有了这些知识，我们就能开始详细了解操作系统和其运行原理。

一个简单的个人计算机可以被抽象为图1-6那样的模型。CPU，内存和IO设备都连接在一条系统总线上，并通过这条总线相互通信。现代操作系统具有更加复杂的结构，有多种总线，我们后面会谈到。暂时来说，这种模型就足够分析问题了。后面的章节中，我们将简要概述上述各个组成部件，并且深入剖析一些操作系统设计者们关系的硬件问题。不用说，这将是个非常简洁的综述。关于计算机硬件和计算机组成的书有很多。两本最著名的是 Tanenbaum and Austin (2012) 和 Patterson and Hennessy (2013)。

###1.3.1 处理器
计算机的大脑是CPU，它从内存中取指令并执行。CPU最简单的工作流程就是，从内存读取第一条指令，解码以确定其类型和操作数，执行它，然后读取，解码，执行后续的指令。这种流程被一直重复，直到程序结束。程序就是这样被运行的。

每种CPU都有其独有的指令集。因此，x86处理器不能执行ARM的程序，反之亦然。因为访问内存读取指令和数据的时间比执行指令的时间长很多，所以所有CPU都拥有一些寄存器，用于存放关键变量和临时结果。因此，指令集都包含了从内存加载数据到寄存器和保存寄存器数据到内存的指令。其他一些指令，将两个操作数组合为一个结果，这两个操作数可以来自内存也可以来自寄存器，或者各取一个；比如就有指令将两个操作数做加法，结果存入寄存器或者内存中。

除了上述用于存放数据的通用寄存器，大多处理器含有一些程序员可见的特殊寄存器。其中之一是**程序计数器**，它包含了下一条要读取的指令的内存地址。处理器读取了一条指令后，程序计数器将被更新，指向下一条指令。

另一个寄存器是**栈指针**，它指向内存中栈的顶端。栈保存了每个已经开始但尚未结束的程序流程的数据帧。这种数据帧包含了入参，局部变量和没有使用寄存器保存的临时变量。

再一个寄存器是**PSW**（程序状态字）。这个寄存器包含了数个条件码bits(*N(negative)Z(zero)V(overflow)C(carry)*)，它们由比较指令来设置，还包含了CPU优先级寄存器，运行模式（用户态或内核态），还有一些其他控制位。用户态程序通常可以读取整个PSW，但是只能写其中一些位。PSW寄存器在系统调用和IO中扮演了重要角色(*x86的EFlags包含了上面的条件码bits*)。

操作系统必须完全感知这些寄存器。对CPU进行分时复用时，操作系统会经常停止正在运行的程序去启动或者重启另外一个程序。每次它停止一个程序的时候，必须把这些寄存器都保存下来，这样，当这个程序再次运行时就可以恢复他们。

为了提高性能，操作系统的设计者早就放弃了对单一指令读取解析执行这一流程。许多现代CPU都有同时并行执行多条指令的能力。比如，某种CPU可能具有分离的读取，解析，执行单元。于是，当它在执行第n条指令时，可能同时在解析第n+1条指令，并同时在读取第n+2条指令。这种组织方式，被称作流水线，图1-7（a）描述了三阶段的流水线结构。实际上流水线通常更长。大多数流水线设计中，一条指令被读取后，它必须被执行。即使之前的指令是条件转移指令。流水线让编译器和操作系统的作者无比头痛，因为他们将不得不直面底层系统的复杂性。

比流水线设计更复杂的是超标量处理器，如图1-7（b）所示。这种设计中，安排了多个执行单元，比如可以同时拥有一个整型运算器，一个浮点型运算器，一个布尔运算器。一次读取2条或者更多的指令，解析后存放在一个缓冲区中，等待执行。一旦有执行单位空闲出来，立即检查缓冲区，看看有没有自己可以执行的指令在其中，如果有则将这条指令从缓冲区中移除并执行。这种设计带来的一个影响是，指令常常会乱序执行。大部分情况下，由硬件来保证程序乱序执行和顺序执行的结果保持一致，但是还是给操作系统强加了一些恼人的复杂性，后面我们会谈到。

除了一些在嵌入式系统中使用的简单CPU，大部分的CPU都有用户态和内核态两种运行模式。一般由PSW寄存器中的一个bit来控制当前运行模式。当处于内核态时，CPU可以执行指令集里的所有指令，并使用所有硬件特性。在桌面电脑或者服务器上，操作系统一般都运行在内核态，可以访问整个硬件。在大多数嵌入式系统中，只有一小段代码运行在内核态，剩余的操作系统代码都运行在用户态。（*这一句是否说反了，嵌入式系统的用户态程序很少，剩下都是操作系统才对吧*）

用户程序通常运行在用户态，只被允许执行指令集的一个子集，只能访问部分硬件特性。大体上说，牵涉到IO和内存保护的指令都不能在用户态执行。比如，设置PSW寄存器中的运行模式位，让CPU进入内核态，理所当然是被禁止了的。

